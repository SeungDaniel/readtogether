# 요한복음 데일리 텔레그램 봇 – 개발 지시서 v2.1

(v2.1: 그룹 답장 리액션 기능 추가)

---

## 0. 프로젝트 목표

요한복음 읽기 로드맵을 기반으로,
1.  **공동체 단톡방**에는 매일 정해진 시간에 “오늘의 본문”을 자동 발송하고, 멤버들의 **답장(Reply)**에 반응해준다.
2.  **개인 1:1 채팅**에서는 **인라인 버튼**을 통해 직관적으로 퀘스트를 수행하는 봇을 만든다.
3.  **성능 최적화**: 구글 시트 API 호출을 최소화하여 반응 속도를 높이고 안정성을 확보한다.

---

## 1. 아키텍처 및 데이터 흐름

### 1.1 핵심 변경 사항
*   **UX (개인)**: 명령어(`/next`) 타이핑 방식 → **인라인 버튼(CallbackQuery)** 클릭 방식.
*   **UX (공동체)**: 봇 메시지에 대한 답장 감지 → **이모지 리액션(👍/❤️)** 피드백.
*   **Data**: 구글 시트 직접 호출 → **로컬 캐싱(Memory/SQLite)** 후 비동기 동기화.

---

## 2. 기능 요구사항 – 공동체 모드 (Group)

### 2.1 답장 인식 및 리액션 (New!)
소규모 공동체(20명 내외)의 활발한 나눔을 위해, 봇이 보낸 메시지에 멤버가 반응하면 봇도 반응해준다.

*   **트리거 조건**:
    *   그룹 채팅방(`group` or `supergroup`)에서 발생한 메시지일 것.
    *   해당 메시지가 **답장(Reply)** 형태일 것.
    *   답장의 원본 메시지(`reply_to_message`)가 **봇이 쓴 메시지**일 것.
    *   (옵션) 원본 메시지 내용에 "공동체 DAY" 같은 키워드가 포함되어 있으면 더 정확함.
*   **동작**:
    *   봇은 사용자의 메시지에 `setMessageReaction` API를 사용하여 이모지(👍, ❤️, 🙏 중 랜덤 또는 고정)를 부착한다.
    *   별도의 텍스트 답장은 보내지 않는다 (채팅창 공해 방지).

---

## 3. 기능 요구사항 – 개인 퀘스트 모드 (1:1)

### 3.1 인라인 버튼 UX 설계
사용자가 채팅창에 명령어를 칠 필요가 없어야 한다.

#### (1) 메시지 하단 버튼 구성
*   **본문 메시지(Quest)** 아래에 항상 다음 액션 버튼을 부착:
    *   `[ ✅ 읽음 완료 (다음으로) ]` (callback_data: `next`)
    *   `[ 📖 다시 읽기 ]` (callback_data: `repeat`)
    *   `[ 📊 내 현황 ]` (callback_data: `status`)

#### (2) `/start_john` (최초 진입)
*   텍스트: "요한복음 퀘스트에 오신 것을 환영합니다!"
*   버튼: `[ 🚀 1일차 시작하기 ]`

### 3.2 로직 상세 (CallbackQueryHandler)

1.  **`next` 버튼 클릭 시**:
    *   `user_id`의 `current_day` 확인.
    *   메모리에 캐싱된 Plan에서 `day` 데이터 가져옴.
    *   메시지 전송 (본문 + 다음 버튼 세트).
    *   **중요**: 기존 메시지의 버튼은 제거하거나 수정(예: "✅ 완료됨")하여 중복 클릭 방지.
    *   DB 업데이트 (`current_day += 1`).

---

## 4. 성능 및 안정성 가이드

### 4.1 캐싱 전략 (Caching Strategy)
*   **PlanRepository**:
    *   `__init__`에서 `plan_sheet` 전체 데이터를 읽어 `self.cache = {day: row}` 형태로 저장.
    *   `get_plan_by_day(day)`는 `self.cache`에서 즉시 반환 (API 호출 0).
    *   `reload()` 메서드 구현: 관리자가 `/reload` 명령을 내리면 다시 시트를 읽어 캐시 갱신.

### 4.2 API 비용 및 속도 관리
*   구글 시트 API는 **Read**보다 **Write**가 느리고 제한이 엄격함.
*   사용자가 버튼을 빠르게 연타할 경우를 대비해, `last_click_time`을 체크하여 **디바운싱(Debouncing)** 처리 (예: 1초 내 재클릭 무시).

---

## 5. 구현 파일 구조 제안

```text
src/
  bot_polling.py       # 메인: CallbackQueryHandler, MessageHandler(Reply 감지)
  daily_broadcast.py   # 공동체 발송
  
  # Repositories
  plan_repository.py     # [수정] 메모리 캐싱 로직 추가
  progress_repository.py # [수정] 쓰기 최적화 (옵션)
  
  # Utils
  keyboard_factory.py  # [신규] 인라인 키보드 생성 헬퍼
```
